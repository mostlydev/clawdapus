FROM node:24-bookworm-slim

RUN apt-get update && apt-get install -y \
    bash ca-certificates cron curl git jq tini \
    python3 python3-pip ruby-full \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g openclaw@2026.2.9

CLAW_TYPE openclaw

# AGENT is overridden per-agent image (see Clawfile.tiverton etc.)
# The base image ships no default agent — subimages must declare one.
AGENT AGENTS.md

# Model defaults — each agent image may override with MODEL primary
MODEL primary openrouter/moonshotai/kimi-k2.5
MODEL fallback openrouter/minimax/minimax-m2.5
MODEL fallback anthropic/claude-sonnet-4-6

# Heartbeat base config — specific schedule and target set per agent image
CONFIGURE openclaw config set agents.defaults.heartbeat.target discord

# HANDLE declares Discord as the transport layer for all trading agents.
#
# Each agent container gets a distinct Discord application identity injected
# at runtime via env vars (DISCORD_BOT_TOKEN, DISCORD_APP_ID).  Bot tokens
# are never baked into the image.
#
# In the monolithic setup, all agents shared a single bot token and a single
# openclaw process.  In this pod, each agent is a fully isolated openclaw
# instance — it owns its own bot account, its own cron daemon, and its own
# workspace filesystem.  Discord is the coordination layer: agents still
# mention each other by ID across container boundaries, exactly as before.
#
# What changes:
#   - No shared openclaw config to accidentally corrupt
#   - Cron schedules live in each agent's Clawfile, not a shared jobs.json
#   - Workspace memory (positions.md, strategy.md) is container-local
#   - Policy and research files are on the shared volume (volume://clawd-shared)
HANDLE discord
CONFIGURE openclaw config set channels.discord.accounts [{"token":"${DISCORD_BOT_TOKEN}","applicationId":"${DISCORD_APP_ID}"}]
CONFIGURE openclaw config set agents.defaults.bindings.discord.accountId ${DISCORD_APP_ID}

# Alpaca credentials — passed via environment at pod startup
CONFIGURE openclaw config set integrations.alpaca.apiKey ${ALPACA_API_KEY}
CONFIGURE openclaw config set integrations.alpaca.secretKey ${ALPACA_SECRET_KEY}

TRACK apt npm

PRIVILEGE worker root
PRIVILEGE runtime claw-user

COPY entrypoint.sh /claw/entrypoint.sh
RUN chmod +x /claw/entrypoint.sh
ENTRYPOINT ["/usr/bin/tini", "--", "/claw/entrypoint.sh"]
